<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="sinkei.css">
    <title>生態系神経衰弱ゲーム（対戦型）</title>
    
</head>
<body>
    <h1 style="display: flex; align-items: center; gap: 20px;">
        生態系神経衰弱ゲーム（対戦型）
        <div id="status-container" style="font-size: 18px; display: flex; flex-direction: column;">
            <div id="turn-counter">ターン数: 1</div>
            <div id="time-remaining">制限時間: 60秒</div>
        </div>
    </h1>

    <div id="game-board"></div>

    <h2 style="display: flex; align-items: center; gap: 20px;">
        自分の手元
        <span id="player-pairs-count">ペア数: 0</span>
        </h2>
        <div id="player-hand-container" style="display: flex; gap: 10px;">
        <div id="player-hand"></div>
        </div>

        <h2 style="display: flex; align-items: center; gap: 20px;">
        相手の手元
        <span id="opponent-pairs-count">ペア数: 0</span>
        </h2>
        <div id="opponent-hand-container" style="display: flex; gap: 10px;">
        <div id="opponent-hand"></div>
        </div>
      
    <h3 id="turn-indicator">あなたのターンです</h3>
        <div id="skill-display" style="margin: 20px 20px 0 auto; border: 1px solid black; padding: 10px;">
            <h3>【プレイヤースキル】</h3>
            <ul id="skill-list" style="list-style: none; padding: 0; margin: 0;">
                <li>
                    <span data-tooltip="カードをシャッフルします">シャッフル</span> → 残り使用回数 2回
                </li>
                <li>
                    <span data-tooltip="1ターンで4枚のカードをめくれます">ダブルフリップ</span> → 残り使用回数 1回
                </li>
                <li>
                    <span data-tooltip="相手の制限時間を30秒短縮します">タイムカット</span> → 残り使用回数 1回
                </li>
            </ul>
        </div>
    </div>
    <script>
        function shuffleCards() {
            const board = document.getElementById("game-board");
            const cards = Array.from(board.children);
            cards.sort(() => Math.random() - 0.5);
            board.innerHTML = "";
            cards.forEach(card => board.appendChild(card));
        }

        function enableDoubleFlip() {
            doubleFlipEnabled = true;
            alert("ダブルフリップが有効になりました！このターンだけ4枚めくれます。");
        }

        function cutOpponentTime() {
            if (!isPlayerTurn) {
                alert("タイムカットは相手ターンでのみ有効です！");
                return;
            }
            timeRemaining = Math.max(0, timeRemaining - 30); // 次の相手ターンの制限時間を30秒短縮
            alert("相手の次のターンの制限時間が30秒短縮されました！");
        }

        let cards = [];
        let shuffledCards = [];
        let flippedCards = [];
        let matchedCards = 0;
        let isPlayerTurn = true; // プレイヤーのターンかどうか
        let doubleFlipEnabled = false;
        
        let turnCount = 1; 
        let timeRemaining = 60; 
        let timerInterval; 

        const turnCounter = document.getElementById('turn-counter');
        const timeRemainingDisplay = document.getElementById('time-remaining');
        
        const playerSkills = [         // ← これも早めに移動
          { name: "シャッフル", action: shuffleCards, remainingUses: 2 },
          { name: "ダブルフリップ", action: enableDoubleFlip, remainingUses: 1 },
          { name: "タイムカット", action: cutOpponentTime, remainingUses: 1 }
        ];
    document.addEventListener("DOMContentLoaded", () => {
        updateSkillDisplay();
        startTimer(); // タイマーを開始

        fetch("animal_cards.json")
            .then(res => res.json())
            .then(data => {
                const selected = data.slice(0, 20); // 最初の20種だけを使用
                const duplicated = [...selected, ...selected];
                shuffledCards = duplicated.sort(() => Math.random() - 0.5);
                initializeGame(shuffledCards);
            });
        
        function initializeGame(shuffledCards) {
            const board = document.getElementById('game-board');
            shuffledCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card', 'hidden');
                cardElement.dataset.name = card.name;

                const imgElement = document.createElement('img');
                imgElement.src = `animal_cards/${card.img}`;
                imgElement.alt = card.name;

                cardElement.appendChild(imgElement);
                cardElement.addEventListener('click', () => flipCard(cardElement));
                board.appendChild(cardElement);
            });
            }


        const playerHand = document.getElementById('player-hand');
        const opponentHand = document.getElementById('opponent-hand');
        const turnIndicator = document.getElementById('turn-indicator');

        function flipCard(cardElement) {
            const maxFlips = doubleFlipEnabled ? 4 : 2; // ダブルフリップが有効なら4枚、それ以外は2枚
            if (flippedCards.length < maxFlips && cardElement.classList.contains('hidden')) {
                cardElement.classList.remove('hidden');
                cardElement.classList.add('flipped'); // カードを回転させる
                flippedCards.push(cardElement);

                if (flippedCards.length === maxFlips) {
                    checkMatch();
                    doubleFlipEnabled = false; // ダブルフリップを無効化
                }
            }
        }

        function checkMatch() {
            if (flippedCards.length === 4) {
                // 4枚めくった場合の処理
                const matchedPairs = []; // ペアを格納する配列

                // ペアを判定
                for (let i = 0; i < flippedCards.length; i++) {
                    for (let j = i + 1; j < flippedCards.length; j++) {
                        if (flippedCards[i].dataset.name === flippedCards[j].dataset.name) {
                            matchedPairs.push(flippedCards[i], flippedCards[j]);
                        }
                    }
                }

                // ペアが1組の場合
                if (matchedPairs.length === 2) {
                    matchedPairs.forEach(card => card.classList.add('matched')); // ペアをマッチ状態にする
                    matchedCards += 2;

                    // ペアを手元に移動
                    setTimeout(() => {
                        matchedPairs.forEach(card => {
                            if (isPlayerTurn) {
                                addToPlayerHand(card);
                            } else {
                                addToOpponentHand(card);
                            }
                        });

                        // ペア以外のカードを裏返す
                        flippedCards.forEach(card => {
                            if (!matchedPairs.includes(card)) {
                                card.classList.remove('flipped');
                                card.classList.add('hidden');
                            }
                        });
                        flippedCards = [];
                        switchTurn();
                    }, 1000);
                } else {
                    // ペアがない場合、全て裏返す
                    setTimeout(() => {
                        flippedCards.forEach(card => {
                            card.classList.remove('flipped');
                            card.classList.add('hidden');
                        });
                        flippedCards = [];
                        switchTurn();
                    }, 1000);
                }
            } else if (flippedCards.length === 2) {
                // 通常の2枚めくりの場合
                const [card1, card2] = flippedCards;
                if (card1.dataset.name === card2.dataset.name) {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    
                    matchedCards += 2;

                    // ペアを手元に移動
                    setTimeout(() => {
                        if (isPlayerTurn) {
                            addToPlayerHand(card1);
                            addToPlayerHand(card2);
                        } else {
                            addToOpponentHand(card1);
                            addToOpponentHand(card2);
                        }
                        flippedCards = [];
                        
                        if (matchedCards === shuffledCards.length) {
                            determineWinner();
                        }
                    }, 1000);
                } else {
                    // ペアが揃わない場合、裏返す
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card1.classList.add('hidden');
                        card2.classList.remove('flipped');
                        card2.classList.add('hidden');
                        flippedCards = [];
                        switchTurn();
                    }, 1000);
                }
            }
        }

        function useSkill(skillIndex) {
            const skill = playerSkills[skillIndex];

            if (!skill) {
                alert("スキルが選択されていません！");
                return;
            }

            if (skill.remainingUses <= 0) {
                alert(`スキル「${skill.name}」はもう使用できません！`);
                return;
            }

            // スキルのアクションを実行
            skill.action();
            skill.remainingUses--; // 使用回数を減らす
            alert(`スキル「${skill.name}」を使用しました！残り使用回数: ${skill.remainingUses}`);

            // スキル表示を更新
            updateSkillDisplay();
        }

        function addToPlayerHand(card) {
            const playerHandContainer = document.getElementById('player-hand');

            // ダミーカードを作ってカードの前に追加
　　　　　　　const dummy = document.createElement('div');
　　　　　　　dummy.classList.add('card', 'dummy');
　　　　　　　card.parentNode.insertBefore(dummy, card);

　　　　　　　　// 場のカードは透明に
　　　　　　　　card.classList.add('cleared');


            // 同じカード名のペアコンテナがあるか確認
            let pairContainer = playerHandContainer.querySelector(`.pair-container[data-name="${card.dataset.name}"]`);
            if (!pairContainer) {
                // なければ新規作成
                pairContainer = document.createElement('div');
                pairContainer.classList.add('pair-container');
                pairContainer.setAttribute('data-name', card.dataset.name);
                pairContainer.style.display = 'inline-flex';
                pairContainer.style.flexDirection = 'column';
                pairContainer.style.alignItems = 'center';
                pairContainer.style.marginRight = '10px';

                const nameLabel = document.createElement('div');
                nameLabel.textContent = card.dataset.name;
                nameLabel.style.fontSize = '12px';
                nameLabel.style.fontWeight = 'bold';
                nameLabel.style.marginBottom = '4px';

                pairContainer.appendChild(nameLabel);
                playerHandContainer.appendChild(pairContainer);
            }

            // カードを横に並べる
            card.classList.remove('hidden');
            card.classList.add('matched');
            card.querySelector('img').style.display = 'block';

            const cardClone = card.cloneNode(true); // 表示用のクローンを作る
　　　　　　　cardClone.classList.remove("cleared");
　　　　　　　cardClone.classList.add("matched");
　　　　　　　cardClone.querySelector("img").style.display = "block";
　　　　　　　pairContainer.appendChild(cardClone); // 手元にはクローンを表示

            // ペア数更新（÷2）
            const playerPairsCount = document.getElementById('player-pairs-count');
            const currentPairs = playerHandContainer.querySelectorAll('.pair-container').length;
            playerPairsCount.textContent = `ペア数: ${currentPairs}`;
        }


        function addToOpponentHand(card) {
            const opponentHandContainer = document.getElementById('opponent-hand');
            
　　　　　　　// ダミーカードを作ってカードの前に追加
　　　　　　　const dummy = document.createElement('div');
　　　　　　　dummy.classList.add('card', 'dummy');
　　　　　　　card.parentNode.insertBefore(dummy, card);

　　　　　　　// 場のカードは透明に
　　　　　　　card.classList.add('cleared');
　
            // 同じカード名のペアコンテナがあるか確認
            let pairContainer = opponentHandContainer.querySelector(`.pair-container[data-name="${card.dataset.name}"]`);
            if (!pairContainer) {
                // なければ新しく作成
                pairContainer = document.createElement('div');
                pairContainer.classList.add('pair-container');
                pairContainer.setAttribute('data-name', card.dataset.name);
                pairContainer.style.display = 'inline-flex';
                pairContainer.style.flexDirection = 'column';
                pairContainer.style.alignItems = 'center';
                pairContainer.style.marginRight = '10px';

                const nameLabel = document.createElement('div');
                nameLabel.textContent = card.dataset.name;
                nameLabel.style.fontSize = '12px';
                nameLabel.style.fontWeight = 'bold';
                nameLabel.style.marginBottom = '4px';

                pairContainer.appendChild(nameLabel);
                opponentHandContainer.appendChild(pairContainer);
            }

            // カード表示処理
            card.classList.remove('hidden');
            card.classList.add('matched');
            card.querySelector('img').style.display = 'block';

            const cardClone = card.cloneNode(true); // 表示用のクローンを作る
　　　　　　　cardClone.classList.remove("cleared");
　　　　　　　cardClone.classList.add("matched");
　　　　　　　cardClone.querySelector("img").style.display = "block";
　　　　　　　pairContainer.appendChild(cardClone); // 手元にはクローンを表示

            // ペア数更新（÷2）
            const opponentPairsCount = document.getElementById('opponent-pairs-count');
            const currentPairs = opponentHandContainer.querySelectorAll('.pair-container').length;
            opponentPairsCount.textContent = `ペア数: ${currentPairs}`;
        }

        // ターン数を更新する関数
        function updateTurnCount() {
            turnCount++;
            turnCounter.textContent = `ターン数: ${turnCount}`;
        }

        function startTimer() {
            clearInterval(timerInterval); // 既存のタイマーをクリア
            timeRemaining = 60; // 制限時間をリセット
            timeRemainingDisplay.textContent = `残り時間: ${timeRemaining}秒`;

            timerInterval = setInterval(() => {
                timeRemaining--;
                timeRemainingDisplay.textContent = `残り時間: ${timeRemaining}秒`;

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('時間切れ！ターンを切り替えます。');
                    switchTurn(); // ターンを切り替え
                }
            }, 1000);
        }

        // switchTurn関数内でターン数を更新
        function switchTurn() {
            isPlayerTurn = !isPlayerTurn;
            turnIndicator.textContent = isPlayerTurn ? 'あなたのターンです' : '相手のターンです';

            // ターン数を更新
            updateTurnCount();

            // タイマーをリセットして再スタート
            startTimer();
        }

        function updateSkillDisplay() {
            const skillList = document.getElementById("skill-list");
            skillList.innerHTML = ""; // リストをクリア

            playerSkills.forEach((skill, index) => {
                const listItem = document.createElement("li");

                // スキル名をクリック可能にする
                const skillName = document.createElement("span");
                skillName.textContent = `${skill.name}`;
                skillName.setAttribute("data-tooltip", getSkillDescription(skill.name));
                skillName.style.cursor = skill.remainingUses > 0 ? "pointer" : "default";
                skillName.style.color = skill.remainingUses > 0 ? "black" : "gray";

                if (skill.remainingUses > 0) {
                    skillName.onclick = () => useSkill(index); // イベントリスナーを1回だけ設定
                }

                listItem.appendChild(skillName);
                listItem.appendChild(document.createTextNode(` → 残り使用回数 ${skill.remainingUses}回`));
                skillList.appendChild(listItem);
            });
        }

        function getSkillDescription(name) {
            switch (name) {
                case "シャッフル":
                    return "場のカードの配置をランダムに並び替えます";
                case "ダブルフリップ":
                    return "このターンだけ最大4枚のカードをめくれます";
                case "タイムカット":
                    return "相手の次のターンの持ち時間を30秒短縮します";
                default:
                    return "";
            }
        }

        function determineWinner() {
            const playerCards = playerHand.children.length;
            const opponentCards = opponentHand.children.length;

            let resultMessage = `ゲーム終了！\nあなたのペア数: ${playerCards}\n相手のペア数: ${opponentCards}\n`;

            if (playerCards > opponentCards) {
                resultMessage += "あなたの勝利です！";
            } else if (playerCards < opponentCards) {
                resultMessage += "相手の勝利です！";
            } else {
                resultMessage += "引き分けです！";
            }

            alert(resultMessage);
        }

    });
    </script>
</body>
</html>
